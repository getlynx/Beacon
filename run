#!/usr/bin/env python3
"""
Launcher that auto-uses a venv when needed (PEP 668 / externally-managed-environment).
Run from project root: ./run  or  python3 run
"""
import os
import subprocess
import sys
from pathlib import Path

PROJECT_ROOT = Path(__file__).resolve().parent
VENV_DIR = PROJECT_ROOT / ".venv"
VENV_PYTHON = VENV_DIR / "bin" / "python"


def in_venv() -> bool:
    return hasattr(sys, "real_prefix") or (
        hasattr(sys, "base_prefix") and sys.base_prefix != sys.prefix
    )


def venv_has_deps() -> bool:
    try:
        r = subprocess.run(
            [str(VENV_PYTHON), "-c", "import pyproj; import textual; import shapely; import packaging"],
            capture_output=True,
            timeout=5,
        )
        return r.returncode == 0
    except Exception:
        return False


def ensure_venv() -> bool:
    if VENV_PYTHON.exists() and venv_has_deps():
        return True
    if not VENV_DIR.exists() or not VENV_PYTHON.exists():
        if VENV_DIR.exists():
            import shutil
            shutil.rmtree(VENV_DIR)
        print("Creating virtual environment...")
        try:
            subprocess.run(
                [sys.executable, "-m", "venv", str(VENV_DIR)],
                check=True,
                cwd=PROJECT_ROOT,
            )
        except subprocess.CalledProcessError:
            sys.exit(
                "Failed to create venv. On Debian/Ubuntu run: apt install python3-venv"
            )
    # Ensure pip is available in the venv
    r = subprocess.run(
        [str(VENV_PYTHON), "-m", "pip", "--version"],
        capture_output=True,
        cwd=PROJECT_ROOT,
    )
    if r.returncode != 0:
        print("Bootstrapping pip...")
        subprocess.run(
            [str(VENV_PYTHON), "-m", "ensurepip", "--upgrade"],
            check=True,
            cwd=PROJECT_ROOT,
        )
    print("Installing dependencies...")
    subprocess.run(
        [str(VENV_PYTHON), "-m", "pip", "install", "-e", "."],
        check=True,
        cwd=PROJECT_ROOT,
    )
    return True


def main() -> None:
    os.chdir(PROJECT_ROOT)
    if in_venv():
        # Already in a venv, run with current Python
        os.execv(sys.executable, [sys.executable, "-m", "beacon"] + sys.argv[1:])
    # Not in venv; use or create .venv
    ensure_venv()
    os.execv(str(VENV_PYTHON), [str(VENV_PYTHON), "-m", "beacon"] + sys.argv[1:])


if __name__ == "__main__":
    main()
